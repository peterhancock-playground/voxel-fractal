<Html>

    <head>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r61/three.min.js"></script>
        <script src="src/octree.js"></script>
        <script src="src/octreeRenderer.js">

        </script>
        <script>
            //script

            function renderReference(scene, width) {
                var c = width / 100;
                var w = width / 2;
                var geometry = new THREE.CubeGeometry(c, c, c);

                var material = new THREE.MeshLambertMaterial({
                    color: 0xff0000
                });

                mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                material = new THREE.MeshLambertMaterial({
                    color: 0x00ff00
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.x += w;
                scene.add(mesh);

                material = new THREE.MeshLambertMaterial({
                    color: 0x0000ff
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.y += w;
                scene.add(mesh);

                material = new THREE.MeshLambertMaterial({
                    color: 0x0000ff
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.z += w;
                scene.add(mesh);

                material = new THREE.MeshLambertMaterial({
                    color: 0xff00ff
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.x += w;
                mesh.position.y += w;
                mesh.position.z += w;
                scene.add(mesh);
            }

            function isVisable(x, y, z) {
                return x + y + z < 1;
            }

            function terminatorSphere(x, y, z) {
                return (x - 1/2) * (x - 1/2) + (y - 1/2) * (y - 1/2) + (z - 1/2) * (z - 1/2) > 1/4;
            }

            function mandelbrot(x, y) {
                var exitTime = 0;
                var c0 = x;
                var c1 = y;
                var xn;
                while(exitTime < 100 && x * x + y * y < 4) {
                    exitTime++;
                    xn = x*x - y*y + c0;
                    y = 2*x*y + c1;
                    x = xn;

                }
                return exitTime;
            }

            function fractalDepth() {
                var frac = _(mandelbrot).memoize(function(x, y) {
                    return '' + x + '-' + y;
                });
                return function(x, y, z) {
                    return z < frac(x, y)/100;
                }

            }

            $(function() {
                var width = window.innerWidth;
                var height = width;
                var w = width / 2;
                var f = fractalDepth();
                var geometryCalc = function(x, y, z) {
                    return isVisable(x, y, z) && f(x, z, y);
                };

                var viewport = {
                    origin: [0, 0, 0],
                    width: 1
                };

                var scene = new THREE.Scene();

                var zoom = 0.9;

                var camera = new THREE.OrthographicCamera(-width * zoom , width * zoom, height * zoom, -height * zoom, - 2000, 1000);
                camera.position.x = 1;
                camera.position.y = 1;
                camera.position.z = 1;
                camera.lookAt(scene.position);

                var directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(-1, 2, 1.5).normalize();
                scene.add(directionalLight);


                var depth = 6;
                materials = [];
                for(var i = 1; i < depth + 2; i ++) {
                    materials.push(new THREE.MeshLambertMaterial({
                        transparent: true, opacity: i/depth,
                        color: 0xeeeeee
                    }));
                }

                var draw = function(viewport, depth) {
                    var w = viewport.width * width / 2;
                    var origin = viewport.origin;
                    geometry = new THREE.CubeGeometry(w, w, w);
                    mesh = new THREE.Mesh(geometry, materials[depth]);
                    mesh.position.x += origin[0] * width;
                    mesh.position.y += origin[1] * width;
                    mesh.position.z += origin[2] * width;
                    scene.add(mesh);
                }

                var tree = Octree.octree(geometryCalc, viewport, depth);
                _.defer(function() {
                    OctreeRenderer.render(tree, viewport, draw, depth);
                    renderer = new THREE.CanvasRenderer();
                    renderer.setSize(window.innerHeight, window.innerHeight);
                    renderer.render(scene, camera);
                    $('#fractal').append(renderer.domElement);
                    renderReference(scene, width);
                });



            })
        </script>
    </head>

    <body>
        <div id="fractal"></div>
    </body>

</html>
