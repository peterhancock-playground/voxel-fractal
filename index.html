<Html>

    <head>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r61/three.min.js"></script>
        <script src="src/octree.js"></script>
        <script src="src/octreeRenderer.js">

        </script>
        <script>
            //script

            function isVisable(x, y, z) {
                return x + y + z > -3;
            }

            function terminatorSphere(x, y, z) {
                return (x - 1/2) * (x - 1/2) + (y - 1/2) * (y - 1/2) + (z - 1/2) * (z - 1/2) > 1/4;
            }

            function mandelbrot(x, y) {
                var exitTime = 0;
                var c0 = x;
                var c1 = y;
                var xn;
                while(exitTime < 100 && x * x + y * y < 4) {
                    exitTime++;
                    xn = x*x - y*y + c0;
                    y = 2*x*y + c1;
                    x = xn;

                }
                return exitTime;
            }

            function fractalDepth() {
                var frac = _(mandelbrot).memoize(function(x, y) {
                    return '' + x + '-' + y;
                });
                return function(x, y, z) {
                    //return z < frac(x, y) / 100;
                    return frac(x, y) === 100;
                }

            }

            $(function() {
                var world = function(x, y, z) {
                    return terminatorSphere(x,y,z)
                };

                world = fractalDepth();

                var geometryCalc = function(x, y, z) {
                    return isVisable(x, y, z) && world(x, z, y);
                };

                var worldViewport = {
                    origin: [-1, -1, -1],
                    width: 2
                };

                var depth = 6;

                // Compute octree for the world viewport
                var tree = Octree.octree(geometryCalc, worldViewport, depth);

                var worldToScreen = function(x, y, z) {
                    var xs = (x - worldViewport.origin[0]) * screenSize / worldViewport.width;
                    var ys = (y - worldViewport.origin[1]) * screenSize / worldViewport.width;
                    var zs = (z - worldViewport.origin[2]) * screenSize / worldViewport.width;
                    return {x: xs, y: ys, z: zs};
                };

                // Render and draw

                var scene = new THREE.Scene();

                var zoom = 1;

                var screenSize = Math.min(window.innerWidth, window.innerHeight)
                var screen = {width: screenSize, height: screenSize};
                var camera = new THREE.OrthographicCamera(-screen.width * zoom , screen.width * zoom, screen.height * zoom, - screen.height * zoom, - 3000, 1000);
                camera.position.x = 1;
                camera.position.y = 1;
                camera.position.z = 1;
                camera.lookAt(scene.position);

                var directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(-1, 2, 1.5).normalize();
                scene.add(directionalLight);

                materials = [];
                for(var i = 0; i < depth; i ++) {
                    materials.push(new THREE.MeshLambertMaterial({
                        //transparent: true, opacity: (i + 1) / depth,
                        color: 0xffffff
                    }));
                }

                var draw = function(viewport, depth) {
                   var cubeWidth = viewport.width * screenSize / worldViewport.width;
                   var origin = viewport.origin;
                   var mesh = new THREE.Mesh(new THREE.CubeGeometry(cubeWidth, cubeWidth, cubeWidth), materials[depth]);
                   _(mesh.position).extend(worldToScreen.apply(this, origin));
                   scene.add(mesh);
                }


                _.defer(function() {
                    // Emit the octree to the drawing routine
                    OctreeRenderer.render(tree, worldViewport, draw, depth);
                    renderer = new THREE.CanvasRenderer();
                    renderer.setClearColorHex(0xffffff, 1)
                    renderer.setSize(screenSize, screenSize);
                    $('#download').hide();
                    renderer.render(scene, camera);
                    $('#fractal').append(renderer.domElement);
                    $('#download').click(function(e) {
                        e.preventDefault();
                        var canvas = renderer.domElement;
                        window.open(canvas.toDataURL('image/png'));
                    }).show();

                });
            });

        </script>
    </head>

    <body>
        <a href="#" id="download" style="display:none;">Download</a>
        <div id="fractal"></div>
    </body>

</html>
